<?php
declare(strict_types=1);

use App\Doctrine\EntityManagerFactory;
use App\Service\ProductService;

require_once __DIR__ . '/../../vendor/autoload.php';

session_start();

$factory = new EntityManagerFactory();

if (isset($_POST['selected_dbs'])) {
    $_SESSION['selected_dbs'] = $_POST['selected_dbs'];
}

$selectedDbs = $_SESSION['selected_dbs'] ?? ['mysql'];

$emConnections = [];
foreach ($selectedDbs as $db) {
    $emConnections[$db] = $factory->getEntityManager($db);
}

if (isset($_POST['add_product'])) {
    foreach ($emConnections as $dbName => $em) {
        $service = new ProductService($em);
        $service->createProduct("Random Product " . strtoupper($dbName), rand(50, 500));
    }
}

$allProducts = [];
foreach ($emConnections as $dbName => $em) {
    $service = new ProductService($em);
    $allProducts[$dbName] = $service->getAll();
}

$dbOptions = ['mysql', 'pgsql', 'sqlite', 'sqlsrv'];
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Doctrine Multi-Database Runtime</title>
    <style>
        body { font-family: Arial; margin: 2rem; }
        .container { display: flex; flex-direction: column; gap: 1rem; }
        .btn { padding: 10px 20px; margin: 5px; border: none; cursor: pointer; border-radius: 6px; }
        .add-btn { background: #9C27B0; color: white; }
        .db-box { display: inline-block; margin-right: 10px; }
        table { border-collapse: collapse; margin-top: 20px; width: 50%; }
        th, td { border: 1px solid #ccc; padding: 8px 15px; text-align: left; }
        h2 { margin-top: 30px; }
    </style>
</head>
<body>

<h1>Doctrine Multi-Database Runtime Switcher</h1>
<p>Select databases to push data to:</p>

<form method="POST" class="container">
    <div>
        <?php foreach ($dbOptions as $db): ?>
            <label class="db-box">
                <input type="checkbox" name="selected_dbs[]" value="<?= $db ?>" 
                    <?= in_array($db, $selectedDbs) ? 'checked' : '' ?>> <?= strtoupper($db) ?>
            </label>
        <?php endforeach; ?>
    </div>
    <button type="submit" class="btn">Switch Databases</button>
    <button type="submit" name="add_product" value="1" class="btn add-btn">Add Random Product</button>
</form>

<?php foreach ($allProducts as $dbName => $products): ?>
    <h2>Products in <?= strtoupper($dbName) ?>:</h2>
    <table>
        <tr><th>ID</th><th>Name</th><th>Price</th></tr>
        <?php foreach ($products as $p): ?>
            <tr>
                <td><?= $p->getId() ?></td>
                <td><?= htmlspecialchars($p->getName()) ?></td>
                <td><?= $p->getPrice() ?></td>
            </tr>
        <?php endforeach; ?>
    </table>
<?php endforeach; ?>

</body>
</html>
